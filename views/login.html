<html lang="en">

<head>
    <meta charset="utf-8" />
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/md5.js"></script>
    <script src="/js/my.js"></script>
    <title>登录</title>
    <style>
        .center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>

<body>
<div class="center">
    <form id="loginForm">
        <table>
            <tr>
                <td>用户名</td>
                <td><input id="user" name="user" type="text" size="20" autofocus /></td>
            </tr>
            <tr>
                <td>密码</td>
                <td><input id="pass" name="pass" type="password" size="20" /></td>
            </tr>
            <tr>
                <td colspan="2" align="center"><button type="submit">登录</button></td>
            </tr>
        </table>
    </form>
    <span id="msg" style="color: red;"></span>
</div>

<script>
    $(document).ready(function () {
        $('#loginForm').submit(function (event) {
            event.preventDefault(); // 阻止表单默认提交刷新页面

            const form = document.querySelector("#loginForm");
            var formData = new FormData(form);

            // 取得用户输入的原始密码并执行 MD5 哈希
            var pass = formData.get("pass");
            var digest = CryptoJS.MD5(pass);
            formData.set("pass", digest); // 直接在客户端对密码执行哈希

            $.ajax({
                url: "/login/submit",
                data: formData,
                method: 'post',
                processData: false, // 必须设置，告诉jQuery不要处理发送的数据
                contentType: false, // 必须设置，告诉jQuery不要设置Content-Type请求头
                enctype: 'multipart/form-data',
                success: function (result) {
                    window.sessionStorage.setItem("auth_token",result.token);
                    // 登录成功，跳转至用户博客列表
                    window.location.href = "/blog/list/" + result.uid;
                }
            }).fail(function (result, result1, result2) {
                // 登录失败，显示错误信息
                $('#msg').html(result.responseJSON.msg);
            });
        });
    });
</script>
</body>

</html>